<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project 1</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      .gridlines line {
        stroke: #bbb;
      }

      .gridlines .domain {
        stroke: none;
      }

      span {
        margin: 1%;
      }
      #scatter {
        margin-left: 5%;
      }
    </style>
  </head>
  <svg id="scatter" height="500" width="950"></svg>

  <body>
    <script>
      const svg = d3.select("svg#scatter");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = { top: 30, right: 25, bottom: 55, left: 100 };
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;

      const requestData = async function () {
        const happinessData = await d3.csv("happiness.csv", d3.autotype);
        console.log(happinessData);
        let gdpData = await d3.csv("gdp-per-capita-worldbank.csv", d3.autotype);
        gdpData = gdpData.filter((d) => {
          return d["Year"] === "2019";
        });
        console.log(gdpData);
        let coffeeData = await d3.csv("coffee-consumption.csv", d3.autotype);
        console.log(coffeeData);

        let chartArea = svg
          .append("g")
          .attr("id", "points")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const coffeeCountries = coffeeData.map((d) => d["Country"]);
        const gdpCountries = gdpData.map((d) => d["Entity"]);
        const happinessCountries = happinessData.map((d) => d["Countries"]);
        let combinedData = [];
        d3.intersection(
          coffeeCountries,
          gdpCountries,
          happinessCountries
        ).forEach((c) => {
          let happyIdx = Number(
            happinessData.filter((d) => d["Countries"] === c)[0][
              "Happiness index, 2022"
            ]
          );
          // console.log(happyL);
          let gdp = Number(
            gdpData.filter((d) => d["Entity"] === c)[0][
              "GDP per capita, PPP (constant 2017 international $)"
            ]
          );

          // console.log(coffeeData.filter((d) => d["Country"]));
          let coffeeBags = Number(
            coffeeData
              .filter((d) => d["Country"] === c)[0]
              ["Coffee Consumption (Bags) "].replace(/[^0-9]/g, "")
          );

          let population = Number(
            coffeeData
              .filter((d) => d["Country"] === c)[0]
              ["Population"].replace(/[^0-9]/g, "")
          );
          let obj = { c, happyIdx, gdp, coffeeBags, population };
          combinedData.push(obj);
        });

        combinedData = combinedData.filter((d) => d["happyIdx"] > 4.5);

        console.log(combinedData);
        const happinessExtent = d3.extent(combinedData, (d) =>
          Number(d["happyIdx"])
        );
        console.log(happinessExtent);
        const gdpExtent = d3.extent(combinedData, (d) => Number(d["gdp"]));
        console.log(gdpExtent);

        const xScale = d3
          .scaleLinear()
          .domain(happinessExtent)
          .range([0, chartWidth]);
        const yScale = d3
          .scaleLinear()
          .domain(gdpExtent)
          .range([chartHeight, 0]);
        let leftAxis = d3.axisLeft(yScale);
        svg
          .append("g")
          .attr("class", "y axis")
          .attr("transform", `translate(${margin.left - 10}, ${margin.top})`)
          .call(leftAxis);

        let leftGridlines = d3
          .axisLeft(yScale)
          .tickFormat("")
          .tickSize(-chartWidth - 10);

        svg
          .append("g")
          .attr("class", "y gridlines")
          .attr("transform", `translate(${margin.left - 10}, ${margin.top})`)
          .call(leftGridlines);

        let bottomAxis = d3.axisBottom(xScale);
        svg
          .append("g")
          .attr("class", "x axis")
          .attr(
            "transform",
            `translate(${margin.left}, ${margin.top + chartHeight + 10})`
          )
          .call(bottomAxis);

        let bottomGridlines = d3
          .axisBottom(xScale)
          .tickFormat("")
          .tickSize(-chartHeight - 10);
        svg
          .append("g")
          .attr("class", "x gridlines")
          .attr(
            "transform",
            `translate(${margin.left}, ${margin.top + chartHeight + 10})`
          )
          .call(bottomGridlines);
        let circles = svg
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);
        combinedData.forEach((d, i) => {
          //const fill = colorScale(d['state']);
          circles
            .append("circle")
            .attr("cx", xScale(d["happyIdx"]))
            .attr("cy", yScale(d["gdp"]))
            .attr("r", (d["coffeeBags"] / d["population"]) * 80)
            .attr("opacity", 0.8);
        });
        // console.log(
        //   d3.intersection(coffeeCountries, gdpCountries, happinessCountries)
        // );
        svg
          .append("text")
          .attr("class", "x")
          .attr("text-anchor", "middle")
          .attr("x", chartWidth / 2 + margin.left)
          .attr("y", chartHeight + 81)
          .text("Happiness Index");
        svg
          .append("text")
          .attr("class", "y")
          .attr("transform", "rotate(-90)")
          .attr("text-anchor", "middle")
          .attr("x", -chartHeight / 2 - margin.top)
          .attr("y", 30)
          .text("GDP Per Capita");
      };
      requestData();
    </script>
  </body>
</html>
